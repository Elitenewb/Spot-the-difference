<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spot the Difference – Player</title>
  <style>
    :root{--bg:#0f1220;--panel:#171a2b;--ink:#e9ecf1;--muted:#a7b0c0;--accent:#7bd4ff;--frame:#2a2f4a;--good:#53d769;--bad:#ff5c5c}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0f1220,#0b0e1a);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{padding:16px 20px;border-bottom:1px solid #23263d;display:flex;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px}
    main{display:grid;grid-template-columns:320px 1fr;min-height:calc(100% - 58px)}
    aside{padding:16px;border-right:1px solid #23263d;background:var(--panel)}
    .section{margin-bottom:16px}
    label{display:block;margin:8px 0 6px;color:var(--muted)}
    input[type="file"],button{width:100%;padding:10px;border:1px solid #2b3152;border-radius:10px;background:#0e1122;color:var(--ink)}
    button{cursor:pointer}
    button.primary{background:var(--accent);border-color:#66c9fb;color:#001019;font-weight:600}
    .row{display:flex;gap:10px}
    .stat{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .card{background:var(--panel);border:1px solid #23263d;border-radius:14px;padding:12px}
    .game{display:grid;grid-template-columns:1fr 1fr;gap:18px;padding:18px}
    .frame{position:relative;border:3px solid var(--frame);border-radius:12px;overflow:hidden;aspect-ratio:4/3;background:#0a0d1b}
    canvas{width:100%;height:100%;display:block}
    .badge{position:absolute;top:8px;left:8px;background:#0008;color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #ffffff22}
    .bar{height:8px;background:#10142b;border:1px solid #2b3152;border-radius:999px;overflow:hidden}
    .fill{height:100%;background:linear-gradient(90deg,#66c9fb,#7bd4ff)}
    .stats{display:flex;gap:10px;flex-wrap:wrap}
    .chip{background:#0e1327;border:1px solid #2b3152;border-radius:999px;padding:6px 10px;color:var(--muted)}
    .center-bottom{position:absolute;left:50%;transform:translateX(-50%);bottom:8px;background:#0008;padding:4px 10px;border-radius:10px;border:1px solid #ffffff22}
    .hintPulse{position:absolute;border:2px solid #fff;border-radius:50%;opacity:0;pointer-events:none}
    .modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center}
    .modal .inner{background:#0f142e;border:1px solid #2b3152;border-radius:16px;max-width:420px;width:92%;padding:20px}
    .modal h2{margin:0 0 12px}
    .modal .row{display:flex;justify-content:space-between;margin-top:10px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0c1022;color:#dfe7ff;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <header>
    <h1>Spot the Difference</h1>
    <div class="stats">
      <div class="chip">Score: <span id="score">0</span></div>
      <div class="chip">Found: <span id="found">0</span>/<span id="need">10</span></div>
      <div class="chip">Bonus: <span id="bonus">1000</span></div>
    </div>
  </header>
  <main>
    <aside>
      <div class="section">
        <label>Load Modified (left)</label>
        <input id="modFile" type="file" accept="image/*" />
        <label>Load Original (right)</label>
        <input id="origFile" type="file" accept="image/*" />
        <label>Load Config (JSON)</label>
        <input id="cfgFile" type="file" accept="application/json" />
      </div>
      <div class="section row">
        <button id="hintBtn">Hint</button>
        <button id="resetBtn">Reset game</button>
      </div>
      <div class="section">
        <label>Custom cursor (PNG, optional)</label>
        <input id="cursorFile" type="file" accept="image/png" />
        <div class="section">
          <button id="fitBtn">Fit to natural size</button>
        </div>
        <div class="section">
          <div class="bar"><div id="bonusFill" class="fill" style="width:100%"></div></div>
          <div class="hint" style="color:var(--muted);margin-top:6px">Bonus counts down from 1000 → 0 over 20s. Each found difference = <b>200</b> + current bonus. Wrong click: <span style="color:var(--bad)">-25</span>.</div>
        </div>
      </div>
    </aside>
    <div class="game">
      <div class="card">
        <div class="frame" id="leftFrame">
          <span class="badge">Modified (clickable)</span>
          <canvas id="baseCanvas" title="Click to reveal"></canvas>
          <canvas id="revealCanvas" style="position:absolute;inset:0"></canvas>
          <div id="upTimer" class="center-bottom">00:00</div>
        </div>
      </div>
      <div class="card">
        <div class="frame">
          <span class="badge">Original (reference)</span>
          <canvas id="origCanvas"></canvas>
        </div>
      </div>
    </div>
  </main>

  <div id="doneModal" class="modal">
    <div class="inner">
      <h2>Complete ✅</h2>
      <p>Total Time: <span id="sumTime">—</span></p>
      <p>Total Score: <span id="sumScore">—</span></p>
      <div class="row">
        <button id="closeModal" class="primary">Close</button>
        <button id="playAgain">Play again</button>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const modFile = document.getElementById('modFile');
    const origFile = document.getElementById('origFile');
    const cfgFile = document.getElementById('cfgFile');
    const cursorFile = document.getElementById('cursorFile');
    const fitBtn = document.getElementById('fitBtn');
    const hintBtn = document.getElementById('hintBtn');
    const resetBtn = document.getElementById('resetBtn');

    const baseCanvas = document.getElementById('baseCanvas'); // shows modified image
    const revealCanvas = document.getElementById('revealCanvas'); // drawn with original patches
    const origCanvas = document.getElementById('origCanvas');
    const leftFrame = document.getElementById('leftFrame');

    const scoreEl = document.getElementById('score');
    const foundEl = document.getElementById('found');
    const needEl = document.getElementById('need');
    const bonusEl = document.getElementById('bonus');
    const bonusFill = document.getElementById('bonusFill');
    const upTimerEl = document.getElementById('upTimer');

    const doneModal = document.getElementById('doneModal');
    const closeModal = document.getElementById('closeModal');
    const playAgain = document.getElementById('playAgain');

    // State
    let modImg = new Image();
    let origImg = new Image();
    let cfg = null; // {radius, points[{xNorm,yNorm}], need, natural{w,h}}
    let found = new Set();
    let score = 0;

    let upStart = 0; // ms
    let upTimerId = null;

    let bonusStart = 0; // ms timestamp for current 20s window
    const BONUS_WINDOW = 20000; // 20s
    const BONUS_MAX = 1000;

    // Canvas helpers
    function drawImages() {
      const bw = baseCanvas.clientWidth, bh = baseCanvas.clientHeight;
      baseCanvas.width = bw; baseCanvas.height = bh;
      revealCanvas.width = bw; revealCanvas.height = bh;
      origCanvas.width = bw; origCanvas.height = bh;
      const bctx = baseCanvas.getContext('2d');
      const octx = origCanvas.getContext('2d');
      bctx.clearRect(0,0,bw,bh); octx.clearRect(0,0,bw,bh);
      if (modImg.complete && modImg.naturalWidth) bctx.drawImage(modImg,0,0,bw,bh);
      if (origImg.complete && origImg.naturalWidth) octx.drawImage(origImg,0,0,bw,bh);
      // keep any existing reveal pixels (redraw from scratch by replaying found)
      const rctx = revealCanvas.getContext('2d');
      rctx.clearRect(0,0,bw,bh);
      for (const idx of found) {
        const p = cfg.points[idx];
        const x = p.xNorm * bw, y = p.yNorm * bh;
        revealPatch(x,y,cfg.radius,1,false); // instantly draw existing reveals
      }
    }

    function fitToNatural() {
      if (!cfg || !cfg.natural) return;
      // maintain frame aspect ratio via CSS; canvas resizes to parent automatically by JS above
      drawImages();
    }

    function startTimers(){
      // Up timer
      upStart = performance.now();
      if (upTimerId) cancelAnimationFrame(upTimerId);
      const tick = ()=>{
        const ms = performance.now() - upStart;
        const s = Math.floor(ms/1000), m = Math.floor(s/60), r = s%60;
        upTimerEl.textContent = `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
        // Bonus
        const bms = Math.max(0, BONUS_WINDOW - (performance.now() - bonusStart));
        const b = Math.round((bms/ BONUS_WINDOW) * BONUS_MAX);
        bonusEl.textContent = b;
        bonusFill.style.width = `${(b/BONUS_MAX)*100}%`;
        upTimerId = requestAnimationFrame(tick);
      };
      upTimerId = requestAnimationFrame(tick);
      resetBonus();
    }

    function resetBonus(){ bonusStart = performance.now(); }

    function normFromEvent(ev, canvas){
      const rect = canvas.getBoundingClientRect();
      const x = (ev.clientX - rect.left) / rect.width;
      const y = (ev.clientY - rect.top) / rect.height;
      return {x,y};
    }

    function distance(ax,ay,bx,by){ const dx=ax-bx, dy=ay-by; return Math.hypot(dx,dy); }

    function revealPatch(x, y, r, targetAlpha = 1, animate=true){
      const ctx = revealCanvas.getContext('2d');
      const bw = revealCanvas.width, bh = revealCanvas.height;
      const radius = r;
      // We'll draw original image through a circular clip to the reveal canvas.
      const drawCircle = (alpha)=>{
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.beginPath(); ctx.arc(x,y,radius,0,Math.PI*2); ctx.closePath();
        ctx.clip();
        ctx.drawImage(origImg,0,0,bw,bh);
        ctx.restore();
      };
      if (!animate){ drawCircle(targetAlpha); return; }
      let a = 0, steps = 10, i=0;
      const step = ()=>{
        i++; a = i/steps * targetAlpha;
        drawCircle(a);
        if (i<steps) requestAnimationFrame(step);
      };
      step();
    }

    function wrongClick(){ score = Math.max(0, score - 25); scoreEl.textContent = score; flashBorder(leftFrame,'bad'); }

    function flashBorder(el,kind){
      el.style.boxShadow = kind==='bad' ? '0 0 0 3px #ff5c5c88 inset' : '0 0 0 3px #53d76988 inset';
      setTimeout(()=> el.style.boxShadow='none', 200);
    }

    function onClickCanvas(ev){
      if (!cfg) return;
      const bw = baseCanvas.width, bh = baseCanvas.height;
      const n = normFromEvent(ev, baseCanvas);
      const x = n.x * bw, y = n.y * bh;
      const r = cfg.radius;
      // find first not-found point within radius
      let hitIndex = -1;
      cfg.points.forEach((p,idx)=>{
        if (hitIndex!==-1) return;
        if (found.has(idx)) return;
        const px = p.xNorm * bw, py = p.yNorm * bh;
        if (distance(x,y,px,py) <= r) hitIndex = idx;
      });
      if (hitIndex === -1) { wrongClick(); return; }
      // Correct hit
      found.add(hitIndex);
      const p = cfg.points[hitIndex];
      revealPatch(p.xNorm*bw, p.yNorm*bh, r, 1, true);
      const currentBonus = Math.max(0, Math.round((BONUS_WINDOW - (performance.now() - bonusStart)) / BONUS_WINDOW * BONUS_MAX));
      score += 200 + currentBonus;
      scoreEl.textContent = score;
      foundEl.textContent = found.size;
      flashBorder(leftFrame,'good');
      resetBonus();
      // Done?
      if (found.size >= (cfg.need || cfg.points.length)) finish();
    }

    function finish(){
      cancelAnimationFrame(upTimerId);
      document.getElementById('sumScore').textContent = score;
      document.getElementById('sumTime').textContent = upTimerEl.textContent;
      doneModal.style.display = 'flex';
    }

    // Hints: flash a 3x radius ring around a random unresolved point
    function doHint(){
      if (!cfg) return;
      const unresolved = cfg.points.map((p,i)=> i).filter(i=> !found.has(i));
      if (!unresolved.length) return;
      const idx = unresolved[Math.floor(Math.random()*unresolved.length)];
      const bw = baseCanvas.width, bh = baseCanvas.height;
      const p = cfg.points[idx];
      const x = p.xNorm*bw, y = p.yNorm*bh; const R = cfg.radius*3;
      const ring = document.createElement('div');
      ring.className = 'hintPulse';
      ring.style.left = (x - R) + 'px';
      ring.style.top = (y - R) + 'px';
      ring.style.width = (R*2)+'px';
      ring.style.height = (R*2)+'px';
      leftFrame.appendChild(ring);
      let flashes = 0;
      const blink = ()=>{
        ring.style.transition = 'opacity 250ms ease';
        ring.style.opacity = (ring.style.opacity==='1') ? '0' : '1';
      };
      const interval = setInterval(()=>{ flashes++; blink(); if (flashes>7){ clearInterval(interval); ring.remove(); } }, 200);
    }

    // Loading & setup
    function readImage(file, imgEl, onload){ const fr = new FileReader(); fr.onload = ()=> imgEl.src = fr.result; fr.readAsDataURL(file); imgEl.onload = ()=>{ drawImages(); if (onload) onload(); }; }
    modFile.onchange = (e)=> e.target.files[0] && readImage(e.target.files[0], modImg);
    origFile.onchange = (e)=> e.target.files[0] && readImage(e.target.files[0], origImg);

    cfgFile.onchange = (e)=>{
      const f = e.target.files[0]; if (!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          cfg = JSON.parse(r.result);
          score = 0; scoreEl.textContent = score;
          found = new Set(); foundEl.textContent = 0;
          needEl.textContent = cfg.need || (cfg.points? cfg.points.length : 10);
          startTimers(); drawImages();
        }catch(err){ alert('Invalid config JSON: '+err.message); }
      };
      r.readAsText(f);
    };

    // Custom cursor PNG
    cursorFile.onchange = (e)=>{
      const f = e.target.files[0]; if (!f) return;
      const url = URL.createObjectURL(f);
      // hotspot roughly center (16,16); adjust as needed
      baseCanvas.style.cursor = `url(${url}) 16 16, crosshair`;
    };

    // Interactions
    baseCanvas.addEventListener('click', onClickCanvas);
    hintBtn.onclick = doHint;
    resetBtn.onclick = ()=>{ if(!cfg) return; score=0; scoreEl.textContent=0; found.clear(); foundEl.textContent=0; const rctx=revealCanvas.getContext('2d'); rctx.clearRect(0,0,revealCanvas.width,revealCanvas.height); startTimers(); drawImages(); };
    fitBtn.onclick = fitToNatural;
    window.addEventListener('resize', drawImages);

    // Modal buttons
    closeModal.onclick = ()=> doneModal.style.display='none';
    playAgain.onclick = ()=>{ doneModal.style.display='none'; resetBtn.click(); };
  </script>
</body>
</html>
